name: Build Tactical Stockfish for Windows

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install MSYS2 and GCC
      run: |
        # Скачиваем и устанавливаем MSYS2
        curl -OL https://github.com/msys2/msys2-installer/releases/download/2023-03-18/msys2-x86_64-20230318.exe
        Start-Process -Wait -FilePath ".\msys2-x86_64-20230318.exe" -ArgumentList "install", "--root", "C:/msys64", "--confirm-command"
        
        # Добавляем MSYS2 в PATH
        $env:PATH = "C:\msys64\usr\bin;$env:PATH"
        
    - name: Install GCC compiler
      shell: bash
      run: |
        # Внутри MSYS2 устанавливаем компилятор
        pacman -Syu --noconfirm
        pacman -S --noconfirm git mingw-w64-x86_64-gcc mingw-w64-x86_64-make
        
    - name: Clone Stockfish
      shell: bash
      run: |
        git clone --depth 1 https://github.com/official-stockfish/Stockfish.git
        cd Stockfish/src
        
    - name: Build Stockfish for Windows
      shell: bash
      run: |
        cd Stockfish/src
        # Компилируем с поддержкой AVX2
        make build ARCH=x86-64-avx2 COMP=mingw -j4
        
    - name: Rename to stockfish.exe
      shell: cmd
      run: |
        cd Stockfish\src
        if exist stockfish.exe (
          echo "stockfish.exe already exists"
        ) else (
          rename stockfish stockfish.exe
        )
        
    - name: Upload Stockfish executable
      uses: actions/upload-artifact@v4
      with:
        name: stockfish-windows-exe
        path: Stockfish/src/stockfish*.exe
        
    - name: Create tactical config
      run: |
        echo "Stockfish Tactical 2026 Configuration" > README.txt
        echo "------------------------------------" >> README.txt
        echo "Commands to run after starting stockfish.exe:" >> README.txt
        echo "setoption name MultiPV value 500" >> README.txt
        echo "setoption name UCI_Chess960 value true" >> README.txt
        echo "setoption name Contempt value 24" >> README.txt
        echo "setoption name Aggressiveness value 150" >> README.txt
        echo "isready" >> README.txt
        
    - name: Upload config
      uses: actions/upload-artifact@v4
      with:
        name: stockfish-config
        path: README.txt
